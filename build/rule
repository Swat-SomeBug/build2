// file      : build/rule -*- C++ -*-
// copyright : Copyright (c) 2014-2015 Code Synthesis Tools CC
// license   : MIT; see accompanying LICENSE file

#ifndef BUILD_RULE
#define BUILD_RULE

#include <string>
#include <typeindex>
#include <functional>     // reference_wrapper
#include <unordered_map>

#include <build/target>
#include <build/prefix_map>

namespace build
{
  class rule
  {
  public:
    virtual void*
    match (target&, const std::string& hint) const = 0;

    virtual recipe
    apply (target&, void*) const = 0;
  };

  typedef std::unordered_map<
    std::type_index,
    prefix_multimap<std::string, std::reference_wrapper<rule>, '.'>> rule_map;

  extern rule_map rules;

  // Fallback rule that check that the path exists.
  //
  class path_rule: public rule
  {
  public:
    virtual void*
    match (target&, const std::string& hint) const;

    virtual recipe
    apply (target&, void*) const;

    static target_state
    update (target&);
  };

  class dir_rule: public rule
  {
  public:
    virtual void*
    match (target&, const std::string& hint) const;

    virtual recipe
    apply (target&, void*) const;

    static target_state
    update (target&);
  };
}

#endif // BUILD_RULE
