// file      : build2/config/module -*- C++ -*-
// copyright : Copyright (c) 2014-2016 Code Synthesis Ltd
// license   : MIT; see accompanying LICENSE file

#ifndef BUILD2_CONFIG_MODULE
#define BUILD2_CONFIG_MODULE

#include <algorithm> // find_if()

#include <butl/prefix-map>

#include <build2/types>
#include <build2/utility>

#include <build2/module>
#include <build2/variable>

namespace build2
{
  namespace config
  {
    // An ordered list of modules each with an ordered list of list of
    // config.* variables and their "save flags" (see save_variable()) that
    // are used (as opposed to just being specified) in this configuration.
    // Populated by the config utility functions (required(), optional())
    // and saved in the order populated.
    //
    struct saved_variable
    {
      reference_wrapper<const variable> var;
      uint64_t flags;
    };

    struct saved_variables: vector<saved_variable>
    {
      // Normally each module only have a handful of config variables and we
      // only do this during configuration so for now we do linear search
      // instead of adding a map.
      //
      const_iterator
      find (const variable& var) const
      {
        return std::find_if (
          begin (),
          end (),
          [&var] (const saved_variable& v) {return var == v.var;});
      }
    };

    struct saved_modules: butl::prefix_map<string, saved_variables, '.'>
    {
      vector<const_iterator> sequence;

      iterator
      insert (string name)
      {
        auto p (emplace (move (name), saved_variables ()));

        if (p.second)
          sequence.push_back (p.first);

        return p.first;
      }
    };

    struct module: module_base
    {
      config::saved_modules saved_modules;
      static const string name;
    };

    void
    boot (scope&, const location&, unique_ptr<module_base>&);

    bool
    init (scope&,
          scope&,
          const location&,
          unique_ptr<module_base>&,
          bool,
          bool,
          const variable_map&);
  }
}

#endif // BUILD2_CONFIG_MODULE
